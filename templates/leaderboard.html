{% extends "base.html" %}

{% block title %}Leaderboard{% endblock %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10 col-xl-8">
      <div class="d-flex align-items-baseline justify-content-between mb-3">
        <h1 class="mb-0">Leaderboard</h1>
        {% if current_team %}
          <span class="text-muted small">Your team: <strong>{{ current_team }}</strong></span>
        {% endif %}
      </div>



      <div class="table-responsive">
        <table class="table table-striped align-middle">

          <thead class="table-light">
            <tr>
              <th scope="col" style="width: 6rem;">Rank</th>
              <th scope="col">Team</th>
              <th scope="col" style="width: 8rem;">Score</th>
              <th scope="col" style="width: 10rem;">Time / Progress</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody">
            {% for row in rows %}
              <tr class="{% if current_team and row.team == current_team %}table-primary{% endif %}">
                <th scope="row">{{ row.rank }}</th>
                <td>{{ row.team }}{% if row.completed_at %} <span class="badge bg-success ms-2">Finished</span>{% else %} <span class="badge bg-secondary ms-2">In progress</span>{% endif %}</td>
                <td>{{ row.score }}</td>
                <td>{{ row.time }}</td>
              </tr>
            {% else %}
              <tr>
                <td colspan="4" class="text-muted">No entries yet.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-3">
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Back to Home</a>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  // Auto-refresh the leaderboard table body every 10 seconds
  (function () {
    function refreshLeaderboard() {
      const tbody = document.getElementById('leaderboardBody');
      if (!tbody) return;
      fetch(window.location.href, { headers: { 'X-Requested-With': 'fetch' } })
        .then(function (res) {
          if (!res.ok) return null;
          return res.text();
        })
        .then(function (html) {
          if (!html) return;
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const fresh = doc.getElementById('leaderboardBody');
          if (fresh) {
            tbody.innerHTML = fresh.innerHTML;
          }
        })
        .catch(function () {
          // ignore transient errors
        });
    }
    // Initial tick after DOM ready, then every 10s
    document.addEventListener('DOMContentLoaded', function () {
      setInterval(refreshLeaderboard, 10000);
    });
  })();
</script>
{% endblock %}
